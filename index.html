<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Camera App</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="camera-page-native">
    <!-- –í–µ—Ä—Ö–Ω—è –∫–Ω–æ–ø–∫–∞ -->
    <button id="close-camera" class="btn btn-secondary camera-close" onclick="window.location.href='words.html'">
        <img src="icons/Close_LG.svg" alt="Close" width="24" height="24">
    </button>
    
    <!-- –û—Å–Ω–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="camera-container">
        <div class="camera-icon">üì∑</div>
        
        <h1 class="camera-title">OCR Scanner</h1>
        <p class="camera-subtitle">–ó—Ä–æ–±—ñ—Ç—å —Ñ–æ—Ç–æ —Ç–µ–∫—Å—Ç—É –¥–ª—è —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è —Ç–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Å–ª—ñ–≤ –¥–æ —Å–ª–æ–≤–Ω–∏–∫–∞</p>
        
        <!-- –ü—Ä–∏—Ö–æ–≤–∞–Ω–∏–π input –¥–ª—è –∫–∞–º–µ—Ä–∏ -->
        <input type="file" id="camera-input" class="camera-input" accept="image/*" capture="environment">
        
        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –∫–∞–º–µ—Ä–∏ -->
        <button id="capture-btn" class="camera-button">
            üì∏ –ó—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ
        </button>
        
        <!-- –ü—Ä–µ–≤'—é –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è -->
        <img id="image-preview" class="image-preview" alt="–ü—Ä–µ–≤'—é —Ñ–æ—Ç–æ">
        
        <!-- –°—Ç–∞—Ç—É—Å -->
        <div id="status" class="status default">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –¥–ª—è —Ñ–æ—Ç–æ</div>
    </div>
    
    <!-- –ü—Ä–∏—Ö–æ–≤–∞–Ω–∏–π canvas –¥–ª—è –æ–±—Ä–æ–±–∫–∏ -->
    <canvas id="canvas"></canvas>
    
    <!-- –ü–æ–ø–∞–ø –¥–ª—è –≤–∏–±–æ—Ä—É —Å–ª—ñ–≤ -->
    <div id="words-popup" class="popup-overlay" style="display: none;">
        <div class="popup-content">
            <div class="popup-header">
                <h3>Select words</h3>
            </div>
            <div class="popup-body">
                <div id="popup-word-chips" class="word-chips"></div>
                <div class="popup-actions">
                    <button id="popup-save" class="btn btn-primary btn-full" disabled>–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    <button id="popup-back" class="btn btn-secondary btn-full">–ù–∞–∑–∞–¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tesseract.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <!-- –°–∫—Ä–∏–ø—Ç –∫–∞–º–µ—Ä–∏ -->
    <script>
        console.log('=== –ù–û–í–ò–ô CAMERA SCRIPT –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–û ===');

        let canvas = document.getElementById('canvas');
        let captureBtn = document.getElementById('capture-btn');
        let cameraInput = document.getElementById('camera-input');
        let imagePreview = document.getElementById('image-preview');
        let statusEl = document.getElementById('status');
        let isProcessing = false;

        // –§—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É
        function updateStatus(message, type = 'default') {
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `status ${type}`;
            }
            console.log(`Status (${type}):`, message);
        }

        // –û–±—Ä–æ–±–∫–∞ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –Ω–∞ –∫–Ω–æ–ø–∫—É –∫–∞–º–µ—Ä–∏
        captureBtn.addEventListener('click', function() {
            console.log('–í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –∫–∞–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω—É...');
            cameraInput.click();
        });

        // –û–±—Ä–æ–±–∫–∞ –≤–∏–±–æ—Ä—É —Ñ–∞–π–ª—É –∑ –∫–∞–º–µ—Ä–∏
        cameraInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            
            if (!file) {
                console.log('–§–∞–π–ª –Ω–µ –æ–±—Ä–∞–Ω–æ');
                return;
            }

            console.log('–§–∞–π–ª –æ–±—Ä–∞–Ω–æ:', file.name, file.size, 'bytes');
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –ø—Ä–µ–≤'—é
            showImagePreview(file);
            
            // –û–±—Ä–æ–±–ª—è—î–º–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
            processImageFile(file);
        });

        // –ü–æ–∫–∞–∑ –ø—Ä–µ–≤'—é –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        function showImagePreview(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
                console.log('–ü—Ä–µ–≤\'—é –ø–æ–∫–∞–∑–∞–Ω–æ');
            };
            
            reader.readAsDataURL(file);
        }

        // –û–±—Ä–æ–±–∫–∞ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        async function processImageFile(file) {
            if (isProcessing) {
                console.log('–û–±—Ä–æ–±–∫–∞ –≤–∂–µ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è...');
                return;
            }

            try {
                isProcessing = true;
                captureBtn.disabled = true;
                updateStatus('–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è...', 'processing');

                // –°—Ç–≤–æ—Ä—é—î–º–æ canvas –∑ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                const imageCanvas = await createCanvasFromFile(file);
                
                console.log('Canvas —Å—Ç–≤–æ—Ä–µ–Ω–æ, —Ä–æ–∑–º—ñ—Ä–∏:', imageCanvas.width, 'x', imageCanvas.height);
                console.log('–ú–µ–≥–∞–ø—ñ–∫—Å–µ–ª—ñ:', (imageCanvas.width * imageCanvas.height / 1000000).toFixed(2), 'MP');

                // –ó–∞–ø—É—Å–∫–∞—î–º–æ OCR
                if (typeof ocrProcessor !== 'undefined') {
                    await ocrProcessor.processImage(imageCanvas);
                } else {
                    console.error('OCR –ø—Ä–æ—Ü–µ—Å–æ—Ä –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∏–π');
                    updateStatus('OCR –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∏–π', 'error');
                }

                console.log('–û–±—Ä–æ–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');

            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è:', error);
                updateStatus('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è', 'error');
            } finally {
                isProcessing = false;
                captureBtn.disabled = false;
            }
        }

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è canvas –∑ —Ñ–∞–π–ª—É
        function createCanvasFromFile(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                
                img.onload = function() {
                    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ä–æ–∑–º—ñ—Ä–∏ canvas
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    const context = canvas.getContext('2d');
                    
                    // –ú–∞–ª—é—î–º–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–∞ canvas
                    context.drawImage(img, 0, 0);
                    
                    console.log('–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–∞–º–∞–ª—å–æ–≤–∞–Ω–æ –Ω–∞ canvas');
                    resolve(canvas);
                };
                
                img.onerror = function() {
                    reject(new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è'));
                };
                
                // –°—Ç–≤–æ—Ä—é—î–º–æ URL –¥–ª—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // –°–∫–∏–¥–∞–Ω–Ω—è —Å—Ç–∞–Ω—É
        function reset() {
            imagePreview.style.display = 'none';
            imagePreview.src = '';
            cameraInput.value = '';
            updateStatus('–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –¥–ª—è —Ñ–æ—Ç–æ');
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        document.addEventListener('DOMContentLoaded', function() {
            console.log('–ù–æ–≤–∏–π camera script —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
            updateStatus('–ì–æ—Ç–æ–≤–æ –¥–æ —Ñ–æ—Ç–æ');
        });

        // –ï–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü—ñ–π –¥–ª—è —ñ–Ω—à–∏—Ö —Å–∫—Ä–∏–ø—Ç—ñ–≤
        window.cameraModule = {
            reset: reset,
            updateStatus: updateStatus
        };
    </script>
    
    <!-- –ù–∞—à—ñ —ñ–Ω—à—ñ —Å–∫—Ä–∏–ø—Ç–∏ -->
    <script src="ocr.js"></script>
    <script src="text.js"></script>
    <script src="database.js"></script>
</body>
</html>
